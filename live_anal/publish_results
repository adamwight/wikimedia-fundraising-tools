#!/usr/bin/env python

import json
import cPickle as pickle
import os

import config
import jail
import lock

unique = os.environ['LOGNAME']
spec_tmp = "/tmp/%s-tests.pickle" % unique
results_tmp = "/tmp/%s-test_results.json" % unique
lockfile = "/tmp/%s-franal-publish-proc.lock" % unique

lock.begin(filename=lockfile)

# do gdocs and simplemediawiki queries in an insolated environment
#FIXME: security is illusory
jail.run("""
import json, cPickle as pickle
import fr.tests

print "Reading test specifications from %(url)s"
tests = fr.tests.read_gdoc_spec(doc="%(url)s")
pickle.dump(tests, open("%(out)s", "w"))
""" % {'url': config.test_spec_url, 'out': spec_tmp})

tests = pickle.load(open(spec_tmp, "r"))

# Compile statistics from the database
results = []
for test in tests:
    print test
    test.load_results()
    results.extend([r.__dict__ for r in test.results])

open(results_tmp, "w").write(json.dumps(results, indent=4))

# store in gdocs spreadsheet
jail.run("""
import json
import fr.tests
results = json.loads(open("%(results)s", "r").read())
fr.tests.update_gdoc_results(doc="%(url)s", results=results)
""" % {'results': results_tmp, 'url': config.test_results_url})

lock.end()
